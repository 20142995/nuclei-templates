id: CVE-2023-3128

info:
  name: Grafana Account Takeover / Authentication Bypass
  author: bhutch
  severity: critical
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2023-3128
    - https://grafana.com/blog/2023/06/22/grafana-security-release-for-cve-2023-3128/
  description: Grafana is validating Azure AD accounts based on the email claim. On Azure AD, the profile email field is not unique and can be easily modified. This leads to account takeover and authentication bypass when Azure AD OAuth is configured with a multi-tenant app.
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:L
    cvss-score: 9.4
    cve-id: CVE-2023-3128
    cwe-id: CWE-290
  metadata:
    max-request: 1
    shodan-query: title:"Grafana"
  tags: cve,cve2023,grafana

http:
  - method: GET
    path:
      - "{{BaseURL}}/login"

    matchers-condition: and
    matchers:
      - type: word
        words:
          - "<title>Grafana</title>"
        part: body
      - type: dsl
        dsl:
          - compare_versions(version, '>= 6.7.0', '< 7.0.0')
          - compare_versions(version, '>= 8.5.0', '< 8.5.27')
          - compare_versions(version, '>= 9.2.0', '< 9.2.20')
          - compare_versions(version, '>= 9.3.0', '< 9.3.16')
          - compare_versions(version, '>= 9.4.0', '< 9.4.13')
          - compare_versions(version, '>= 9.5.0', '< 9.5.5')
          - compare_versions(version, '>= 10.0.0', '< 10.0.1')

    extractors:
      - type: regex
        part: body
        internal: true
        name: version
        group: 1
        regex:
          - '\"version\"\:\"([0-9.]+)\"}'
          - '\"subTitle\":\"Grafana v([0-9.]+)'
